<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-register">
    <template>
        <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
        <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
        <template is="dom-if" if="{{_notLoggedIn}}">
            <div id="p4mRegisterContainer" class$="{{_topClass}}">

                <div>
                    <div class="p4m-register-middle">
                        <div class="p4m-register-explain">
                            <div id="p4m-profile-container" class$="{{_topClass}}">
                                <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
                                <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
                                <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
                                <paper-spinner id="spinner"></paper-spinner>         
                            </div>
                            <img class="p4m-register-logo" src="../p4m-shared/img/logo-stacked-white.png" id="peli-icon-header" />
                            <p><em>Your parcel delivered. First time, every time.</em></p>
                        </div>
                        
                        <button type="submit" on-tap="requestLogin" class="p4m-button white p4m-button-active p4m-register-button"><i class="p4micon-cart-empty"><!-- <span class="cart-items-number noitems">2</span> --></i>Use 1 Click Checkout</button>
                        
                        <p class="p4m-register-text-link">Don't have an account? <a on-click="onSignUp">Sign up</a></p>
                    </div>
                </div>
            </div>
        </template>
    </template>



    <script>
        // All this widget does is provide a btn that allows a consumer to register with P4M
        // clicking the btn will open a popup and load a local call to the server which checks
        // for things like is the user logged in and have they just purchased something.
        // If the user is logged in, the local call redirects to the retailer API which saves the consumer details
        // The user is ultimately redirected to the P4M ID server to complete the registration
        Polymer({
            is: "p4m-register",

            properties: {
                _topClass: {
                    type: String,
                    value: "active"
                },
                _loggedIn: {
                    type: Boolean
                },
                _notLoggedIn: {
                    type: Boolean
                }
            },

            ready: function ()
            {
                this.load();
            },

            load: function () {
                //Check to see if the user is logged in - if so just thank them for using P4M :)
                var token = this.$.p4mTokenCookie.readCookie();
                this.set('_loggedIn', token !== "");
                this.set('_notLoggedIn', !this._loggedIn);
            },

            onSignUp: function (e) {
                // we have a token from PP so now we can launch PP in a popup
                var signupUrl = "//" + window.location.host + "/p4m/signup";
                this.openPopup(signupUrl, "signupWindow", 650, 750);
            },

            requestLogin: function () {
                var event = new CustomEvent('p4m-request-login');
                window.dispatchEvent(event);
            },

            openPopup: function(url, id, w, h) {
                // open the popup
                var left = (screen.width / 2) - (w / 2);
                var top = (screen.height / 2) - (h / 2);
                window.open(url, id, 'toolbar=no, location=no, directories=no, status=no, menubar=yes, copyhistory=no, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
            },
        });
    </script>
</dom-module>