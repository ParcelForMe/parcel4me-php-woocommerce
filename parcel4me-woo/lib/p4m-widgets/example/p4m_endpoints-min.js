function returnTemplateFile(e,t,s,o){fs.readFile("static_api/templates/"+e,function e(n,r){n&&o.status(500).send(n),r=r.toString("utf8").replace(t,s),o.set("Content-Type","text/html"),o.status(200).send(r),o.end()})}var Express=require("express"),Cookies=require("cookies"),request=require("request"),fs=require("fs");exports.getP4MAccessToken=function(e,t){var s=new Cookies(e,t);s.get("p4mState")!=e.query.state&&t.status(500).send("Authentication error (p4mState)");var o="https://dev.parcelfor.me:44333/connect/token",n={grant_type:"authorization_code",code:e.query.code,redirect_uri:"http://localhost:8081/p4m/getP4MAccessToken",client_id:"10006"},r={url:"https://dev.parcelfor.me:44333/connect/token",headers:{Authorization:"Basic "+new Buffer("10006:secret").toString("base64"),"Content-Type":"application/x-www-form-urlencoded"},form:n};request.post(r,function(e,o,n){var r=new Date,a={path:"/",expires:new Date(r.setFullYear(r.getFullYear()+1)),httpOnly:!1};s.set("p4mToken",JSON.parse(n).access_token,a),t.status(200).send("<script>window.close();</script>"),t.end()})},exports.localLogin=function(e,t){var s=new Cookies(e,t),o=new Date,n={path:"/",expires:new Date(o.setFullYear(o.getFullYear()+1)),httpOnly:!1};s.set("p4mAvatarUrl","http://localhost:8081/profile.png",n),s.set("p4mGivenName","Guest",n),s.set("p4mDefaultPostCode","4000",n),s.set("p4mDefaultCountryCode","AU",n),s.set("p4mOfferCartRestore","true",n),s.set("p4mLocalLogin","true",n),t.status(200).json({RedirectUrl:null,Success:!0,Error:null}),t.end()},exports.checkout=function(e,t){var s=new Cookies(e,t);if(0)console.log("THIS NEVER HAPPENS CURRENTLY.. but if i stored the gfs-access-token somewhere then I could do this logic .."),returnTemplateFile("checkout.html","[gfs-access-token]",base64Token,t);else{var o="https://identity.justshoutgfs.com/connect/token",n={grant_type:"client_credentials",scope:"read checkout-api"},r={url:"https://identity.justshoutgfs.com/connect/token",headers:{Authorization:"Basic "+new Buffer("parcel_4_me:needmoreparcels").toString("base64"),"Content-Type":"application/x-www-form-urlencoded"},form:n};request.post(r,function(e,o,n){var r=new Date,a={path:"/",expires:new Date(r.setFullYear(r.getFullYear()+1)),httpOnly:!1};console.log("HERE with ",n);var c=new Buffer(JSON.parse(n).access_token).toString("base64");s.set("gfsCheckoutToken",c,a),returnTemplateFile("checkout.html","[gfs-access-token]",c,t)})}},exports.itemQtyChanged=function(e,t){var s={Success:!0};t.status(200).json(s)},exports.updShippingService=function(e,t){var s={Discount:0,Error:null,Shipping:e.body.Amount,Success:!0};s.Tax=Math.floor(s.Shipping/10),s.Total=s.Tax+s.Shipping,t.status(200).json(s)};