<link rel="import" href="../../polymer/polymer.html"/>
<link rel="import" href="../local-image/local-image.html" />

<dom-module id="gfs-droppoint">

	<template>
		<style>
            .content {
                 cursor: pointer;
                 width: 100%;
            }

			h3 {
				margin-top: 0px;
			}

			ul {
			}

			li {
				display: flex;
                flex-direction: row;
			}

			tr {
				line-height: 0.6em;
			}
			td {
				padding: 0 0 1px 0;
			}

			.content-container {
				cursor: pointer;
				flex: 1;
				position: relative;
			}

			.overlay {
				margin: auto;
				width: 100%;
			}

			.overlay .special-badges {
				float: none;
			}

            .overlay #dp-minor-info {
                display: block;
            }

            .dp-large-card .dp-details {
                display: flex;
                flex-direction: column;     
                min-height: 175px;     
            }

            .dp-large-card #dp-minor-info {
                display: block;
                
            }

			.no-button button {
				display: none;
			}

			.no-button.dp-card .actions {
				display: none;
			}

			.no-button.dp-card {
				/*height: 208px;*/
			}

			.dp-card {
				padding: 10px;
				margin: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}

            .dp-large-card {
				padding: 10px;
				margin: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}

			.dp-mini-card {
				padding: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
                margin-right: 20px;
                margin-bottom: 10px;
			}


			.dp-card .content {
				display: flex;
			}

			.dp-card .content .dp-details {
				width: 66%;
				overflow: hidden;
			}

			.dp-small-heading {
				margin-top: 8px;
				margin-bottom: 0px;
				font-size: 0.6em;
			}

			.label {
				color: white;
				font-weight: bold;
			}

			.dp-content {
				width: 100%;
			}

			#dp-address {
				text-align: left;
                clear: both;            
			}

			.open-late {
				font-size: 0.5em;
				padding: 4px;
			}

			#dp-distance {
				margin-bottom: 0px;
			}

			#dp-distance .fa {
				margin-right: 0.2em;
			}

			.choose-droppoint {
				border: none;
				background: #eaeaea;
				color: #fff;
				margin-top: 3px;
				padding: 8px 20px;
				text-align: center;
				text-decoration: none;
				font-size: 16px;
				/*float: right;*/
				cursor: pointer;
				-webkit-transition: all 0.2s ease;
				-moz-transition: all 0.2s ease;
				-o-transition: all 0.2s ease;
				transition: all 0.2s ease;
				position: absolute;
				top: 2px;
				right: 2px;
				border-radius: 50%;
				padding: 0;
			}

			.choose-droppoint:hover {
				background-color: #7bc78f;
				color: #fff;
			}

			.choose-droppoint.chosen {
				background-color: #37a553; /* Green */
				color: #fff;
			}

				.choose-droppoint.chosen:hover {
					opacity: .8;
				}

			.choose-droppoint.unchoose {
				background-color: #7bc78f; /* Green */
			}

			.choose-droppoint.unchoose:hover {
				opacity: .8;
			}

			.dp-opening-hours table {
				margin-top: 4px;
				width: 100%;
			}

			div.dp-day-name {
				font-weight: bold;
			}

			.b-cancel {
			}

			.b-tick {
				display: block;
				height: 32px;
				width: 32px;
                float: right;
			}

			.b-tick.unchosen {
                display: none;
				background-image: url('./images/tick.png');
				background-position: -6px 0;
				background-repeat: no-repeat;
			}

			.b-tick.chosen {
				background-image: url('./images/tick_on.png');
				background-position: -6px 0;
				background-repeat: no-repeat;
			}

			.special-badges {
				margin: 5px 0 0;
				display: flex;
				float: right;
			}

			.open-late {
				background-image: url('./images/opensign.png');
				background-repeat: no-repeat;
				background-size: 26px 26px;
				width: 32px;
			}

			.parking {
				background-image: url('./images/parking.png');
				background-repeat: no-repeat;
				background-size: 32px 32px;
				width: 32px;
			}

			.open-late .badge-text {
				margin-top: 22px;
				font-weight: bold;
			}

			.overlay .open-late {
				-webkit-filter: invert(1);
				filter: invert(1);
			}



			/* MP customization */
			.dp-card {
				width: 336px;
				height: 340px;
				margin: 10px 20px 10px 0;
			}

            .dp-mini-card {
			}

            .dp-large-card {
                width: auto;
            }

            .dp-large-card .content {
                display: flex;
                flex-direction: row;
            }

            .dp-large-card .dp-opening-hours {
                width: 280px;
                xpadding-left: 10px;
            }

            .dp-large-card .dp-header {
                width: 300px;
                margin-right: 10px;
            }

            label {
            }


			/* opening hours table style */
			td.dp-day-time-slots {
				line-height: 10px;
			}

			.dp-day-name, .dp-day-time-slot {
				font-size: 12px;
				line-height: 13px;
				padding-top: 0;
				padding-bottom: 0;
			}

			#infobox-droppoint .dp-day-name, #infobox-droppoint .dp-day-time-slot {
				font-size: 11px;
				line-height: 11px;
				padding-top: 0;
				padding-bottom: 0;
			}

			.multi-times {
				line-height: 20px
			}

			.dp-icon {
				margin: 0 0 5px;
                float: left;
			}

			#dp-address, #dp-distance {
				font-size: 13px;
			}

            #dp-distance {
                margin-right: 10px;
            }

			/* clear floats */
			.clear-fl {
				clear: both;
			}

			.overlay {
				font-size: 13px;
			}

			#dp-address {
			}

            input[type="radio"] {
                display: inline-block;
            }

            span.gfsmethodname {
                display: flex;
                flex-direction: column;
				justify-content: flex-start;
				margin: 6px 0;
            }

            #dp-body {
                width: 100%;
                overflow: hidden;
                padding: 0px;
                margin: 0px;
            }

		</style>


		<div class$="{{containerClass}}" on-click="_onClick">
			<template is="dom-if" if="{{title}}">
				<h3>{{title}}</h3>
			</template>

			<div class="content">

				<div class="dp-details">

					<div class="dp-icon">
						<template is="dom-if" if="{{droppointData.providerName}}">
							<local-image img-src="{{droppointData.providerName}}.png" local-folder="gfs-droppoint/images" class="imageicon" height="45"></local-image>
						</template>
					</div>
					<div class="content">
						<div class="dpProviderName">{{droppointData.providerName}} <template is="dom-if" if="{{isTickButton}}"><div class$="b-tick {{buttonClass}}"></div></template>
						</div>

						<div id="dp-address">
							<template is="dom-repeat" items="{{droppointData.geoLocation.addressLines}}">
								<template is="dom-if" if="{{item}}">
									{{item}}
									<br />
								</template>
							</template>
							{{droppointData.geoLocation.town}}, {{droppointData.geoLocation.postCode}}
						</div>
						<template is="dom-if" if="{{showDistance}}">
							<div id="dp-distance">
								<div class="font-weight-600">Distance:</div>
								<i class="p4micon-map-marker"></i>{{droppointData.localizedDistance}}
							</div>
						</template>

						<div id="dp-body">
							<div id="dp-minor-info">
								<div class="dp-opening-hours">
									<table>
										<template is="dom-repeat" id="openingHoursTemplate" items="{{_weekCollection}}">
											<tr>
												<td class="dp-day-name"><ul><li>{{item.day}}</li></ul></td>
												<td class="dp-day-time-slots">
													<ul class="testMe">
														<template is="dom-repeat" items={{item.timeSlots}}>
															<li class="dp-day-time-slot">{{item.fromTime}} - {{item.toTime}}</li>
														</template>
													</ul>
												</td>
											</tr>
										</template>
									</table>
								</div>
							</div>
						</div>

						<template is="dom-if" if="{{showShippingOptions}}">
							<template id="shippingOptionsIfTemplate" is="dom-if" if="{{droppointData.selected}}">
								<div class="shippingOptions">
									<ul>
										<template id="weekCollectionTemplate" is="dom-repeat" items="{{droppointData.deliveries}}">
											<li class="delivery-place">

												<label for$="dp-{{item.service.id}}">
													<span class="gfsmethodname"><span class="price">{{currencySymbol}}{{item.service.price}}</span><span class="info">{{item.service.methodTitle}}</span>
													<span class="daterange">{{item.deliveryDateRange}}</span>
												</label>

												<i name="shipping_method" 
													on-click="onClickOption" 
													value="{{item.service.id}}" 
													id="dp-{{item.service.id}}" 
													class$="p4micon-check-circle link droppoint-delivery-selection {{item.className}}"
													></i>
												<!-- <i name="shipping_method" 
													on-click="onClickOption" 
													value="shipping_method_{{_id}}" 
													id="dp-{{item.service.id}}" 
													class$="p4micon-check-circle-fill link droppoint-delivery-selection selected _{{item._originalMethodObject.selected}}"
													></i> -->
												<!--<input type="radio"
													name="shipping_method_{{_id}}"
													checked="{{item.selected}}"
													value="{{item.service.id}}"
													id="dp-{{item.service.id}}"
													on-click="onClickOption"
													class="radio droppoint-delivery-selection" /> -->

											</li>
										</template>
									</ul>
								</div>
							</template>
						</template>

						<div class="actions">
							<template is="dom-if" if="{{isStandardButton}}">
								<div on-click="toggleChooseDropPoint" class$="choose-droppoint {{buttonClass}}"><i class="p4micon p4micon-check"></i></div>
							</template>
						</div>
					</div>
				</div>
			</div>
		</div>
	</template>

	<script>

        Polymer({
            is: "gfs-droppoint",

            properties: {
                title: {
                    type: String
                },

                droppointData: {
                    type: Object,
                    value: {}
                },

                containerClass: {
                    type: String,
                    value: "content-container"
                },

                showDistance: {
                    type: Object,
                    value: true
                },
                showShippingOptions: {
                    type: Object,
                    value: false
                },
                currencySymbol: {
                    type: String,
                    value: "£"
                },

                //== Button
                buttonType: {
                    type: String,
                    value: "standard"
                },
                buttonNotSelectedClass: {
                    type: String,
                    value: "not-selected"
                },
                buttonSelectedClass: {
                    type: String,
                    value: "selected"
                },
                buttonClass: {
                    type: String,
                    value: "droppoint-button"
                },

                //== Private properties
                _weekCollection: {
                    type: Array,
                    notify: true
                },
                _id: {
                    type: String,
                    value: Math.floor(Math.random() * 99999) + (new Date().getDate()).toString()
                }
            },

            observers: [
                //"selectedChanged(data.selected)"
                //"_onShippingOptionSelected(data.deliveries.*.selected)"
            ],
            listeners: {
               // "select-delivery-option": "_onShippingOptionsChanged"
            },

			ready: function () {

				var self = this;
				this.initData();

                //Set the button type, if any
				if (this.buttonType === "none")
				{
					this._isTickButton = false;
					this._isStandardButton = false;					
				} 
				else {
					this._isTickButton = (this.buttonType === "tick");
					this._isStandardButton = !this._isTickButton;
				}

			    //Listen for a droppoint being selected somewhere on the page
			    //Window-level listener, to ensure that we get our peers
				window.addEventListener('droppoint-selected', this.onOtherDroppointSelected.bind(this), false);
			},


			initData: function () {
                //Set a unique ID
			    this._id = Math.floor(Math.random() * 99999) + (new Date().getDate()).toString()

                //Ensure 'selected' has a value
			    if (typeof (this.droppointData.selected) === "undefined") {
				    this.droppointData.selected = false;
				}

                //Build a nice week view of delivery methods
                this.buildWeekCollection();

			},

			buildWeekCollection: function() {
			    if (this.droppointData.collectionSlots) { // && this.droppointData.collectionSlots) {
			        this.droppointData.distanceInKm = (Math.round(this.droppointData.distanceInMeters / 100)) / 10;

					var dayCount = 0;
					var self = this;
					var weekCollection = [];
					this.droppointData.weekCollectionSlots = [];
					if (!this.droppointData.collectionSlots) this.droppointData.collectionSlots = [];

					this.droppointData.collectionSlots.forEach(function (collectionSlot) {
						dayCount++;
						if (dayCount <= 7) {

							collectionSlot.collectionDateTime = self._getUtcTime(new Date(collectionSlot.collectionDate));
							collectionSlot.day = DOW_NAMES[collectionSlot.collectionDateTime.getDay()];

							collectionSlot.timeSlots.forEach(function (timeSlot) {
							    timeSlot.fromTime = timeSlot.from; //self._getTimeStr(timeSlot.fromDateTime);
							    timeSlot.toTime = timeSlot.to; //self._getTimeStr(timeSlot.toDateTime);
							});
								
							if (collectionSlot.timeSlots.length > 0) {;
							    weekCollection.push(collectionSlot);
							}

						}
					});

					this.set('_weekCollection', weekCollection);
					//this.$.weekCollectionTemplate.render();
				}
			},

			select: function() {
			    this.set('droppointData.selected', true);
			    this.buildWeekCollection();
			    //this.autoSelectMethod();
                
			    //this.fire('droppoint-selected', this.droppointData);
			},


			unselect: function () {
			    this.set('droppointData.selected', false);
			    this.render();
			},

            //== Global event handler
            //Another droppoint widget has been selected. React to this, by:
            // * selecting myself (if the other widget represents the same droppoint), or;
			// * unselecting myself (otherwise).
			onOtherDroppointSelected: function (e) {
			    
			    var dp = e.detail;
			    if (!this.droppointData) return;

                //If the droppoint selected was this one, make sure this "selected" value reflects the other one
			    if (dp.droppointId == this.droppointData.droppointId) {
			        if (this.droppointData.selected !== dp.selected) {
			            this.set('droppointData', dp);
			        }
			        this.render();

			        return;
			    }
                //If it's another one and it's been selected, unselect me
			    else if (dp.selected) {
			        this.unselect();
			    }
			},

            //Update the button appearance based on whether this droppoint is selected or not
			render: function () {

			    if (!this.droppointData) {;
                    console.error("No droppoint data")
			        return;
			    }
			    else if (this.droppointData.selected) {
				    this.set('buttonClass', this.buttonSelectedClass);
					this.buttonText = "Selected";
				}
				else {
				    this.set('buttonClass', this.buttonNotSelectedClass);
					this.buttonText = "Select";
				}
			},

			onClickOption: function (e) {
			    this.selectMethod(e.target.value);
			},

            //Select a shipping option by ID
            //Fire on-select-delivery-option to be received by parent
            //Set deliveries[n].selected to true on selected method, false on all others
			selectMethod: function (shippingOptionId, supressEvent) {
			    this.select();
			    for (var i=0; i< this.droppointData.deliveries.length; i++) {
			        var item = this.droppointData.deliveries[i];
			        if (this.droppointData.deliveries[i].service.id == shippingOptionId) { //IMPORTANT: Don't use === here
			        	this.set("droppointData.deliveries." + i + ".selected", true);
			        	this.set("droppointData.deliveries." + i + ".className", "selected");
			        }
			        else {
			        	this.set("droppointData.deliveries." + i + ".selected", false);
			        	this.set("droppointData.deliveries." + i + ".className", "unchosen");
			        }
			        //this.set("droppointData.deliveries." + i + ".selected", item.service.id == shippingOptionId); //IMPORTANT: Don't use === here


			    }
			    var method = this.getSelectedMethod();
			    this.droppointData.deliveryMethod = method.service.id;
			    if (!supressEvent) {
			    	this.fire('droppoint-selected', this.droppointData);
			    }
			    
			},

			getSelectedMethod: function () {
			    var result = null;
			    for (var i = 0; i < this.droppointData.deliveries.length; i++) {
			        var item = this.droppointData.deliveries[i];
			        if (item.selected) {
			            result = item;
			            break
			        }
			    }
			    return result;

			},

            //Autoselect a method if no method has been chosen yet
			autoSelectMethod: function() {
			    if (this.droppointData.deliveries) {
			        if (!this.getSelectedMethod()) {
			            this.selectMethod(this.droppointData.deliveries[0].id);
			        }
			        
			    }
			    else {
			        console.error("No delivery options available");
			    }
			},

            /*
			_onShippingOptionsChanged: function() {
			    this._onShippingOptionSelected();
			},
            */

			_getUtcTime: function (d) {
				var utc = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds());
				return utc;
			},

			_getTimeStr: function (d) {
				var minutes = d.getMinutes().toString().length == 1 ? '0' + d.getMinutes() : d.getMinutes();
				var hours = d.getHours() > 12 ? (d.getHours() % 12).toString() : d.getHours().toString();
				var ampm = d.getHours() >= 12 ? 'pm' : 'am';
				return hours + ':' + minutes + ampm;
			},

			_onClick: function () {
			    this.select();
			    this.fire('user-select');
			}

		});
	</script>
</dom-module>
