
<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../iron-input/iron-input.html" />


<dom-module id="p4m-discount-input">

    <template>
        <div id="content">
            <div id="drawer" class="hidden">
                <input is="iron-input" type="text" id="discountCode"  on-keydown="_onKeyDown" bind-value="{{discountCode}}" placeholder="Discount code" />   
            </div> 
                <a href="#" id="prompt" class="icon" on-click="show"><i class="p4micon-add-circle"></i></a>
                <a href="#" id="prompt" class="icon" on-click="hide"><i class="p4micon-delete-circle"></i></a>                    
            <div id="p4mDiscountInputError" class="hidden">{{errorMsg}}</div>
        </div>
        <p4m-api id="localApi" is-local="true"></p4m-api>
    </template>


    <script>

        Polymer({
            is: "p4m-discount-input",

            properties: {
                discountCode: {
                    type: String
                },
                errorMsg: {
                    type: String
                }
            },
            listeners: {

            },
            ready: function()
            {

            },
            show: function() {
                this.$.drawer.classList.remove("hidden");
                this.$.prompt.classList.add("hidden");
                this.showError("");
            },

            hide: function () {
                this.$.drawer.classList.add("hidden");
                //this.$.prompt.classList.remove("hidden");
            },

            _onKeyDown: function (e) {
                //console.log(e);
                if (e && e.key && e.key === 'Enter') {
                    this.sendCode();
                }
                else {
                    this._delayedSend();
                }
            },

            _delayedSend: function () {
                if (this._sendTimeout) {
                    window.clearTimeout(this._sendTimeout);
                }
                this._sendTimeout = window.setTimeout(this.sendCode.bind(this), 1000);
            },

            sendCode: function() {
                this.$.localApi.call('applyDiscountCode', null, { discountCode: this.discountCode }, this.onResponse.bind(this));
            },
            onResponse: function (e, data) {
                if (e) {
                    if (e.error) {
                        this.showError(e.error);
                    } else {
                        this.showError("This isn't a valid discount code");
                    }
                }
                else {
                    this.showError("Discount applied", true);
                    this.hide();
                    this.fire('discount', data);
                    this.discountCode = null;
                }
            },
            showError(msg, success) {
                if (msg) {
                    this.$.p4mDiscountInputError.classList.remove('hidden')
                }
                else {
                    this.$.p4mDiscountInputError.classList.add('hidden')
                }
                if (success) {
                    this.$.p4mDiscountInputError.classList.add('success')
                }
                else {
                    this.$.p4mDiscountInputError.classList.add('error')
                }
               this.errorMsg = msg;
            }

        });
    </script>
</dom-module>