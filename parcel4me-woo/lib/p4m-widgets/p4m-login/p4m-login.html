<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../iron-ajax/iron-ajax.html" />
<link rel="import" href="../../paper-dialog/paper-dialog.html" />
<link rel="import" href="../../polymer-cookie/polymer-cookie.html" />
<link rel="import" href="../../paper-spinner/paper-spinner.html" />
<link rel="import" href="../../paper-menu/paper-menu.html" />
<link rel="import" href="../../paper-item/paper-item.html" />
<link rel="import" href="../p4m-profile/p4m-profile.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-shared/p4m-shared.html" />
<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-login">

    <template>  
        <p4m-profile id="p4mProfile" on-click="launchPopup" on-mouseover="_mouseOverMenu" on-mouseleave="_mouseOutMenu"></p4m-profile>
        <div id="p4m-menu-wrapper" class="p4m-menu hidden" on-mouseleave="_mouseOutMenu" on-mouseover="_mouseOverMenu">
            <paper-menu id="p4m-menu" on-iron-select="_selectMenuItem">
                <paper-item>Sign out:</paper-item>
                <paper-item> - this site</paper-item>
                <paper-item> - this device</paper-item>
                <paper-item> - all devices</paper-item>
                <paper-item>Restore last cart</paper-item>
                <paper-item>Saved items</paper-item>
                <paper-item>P4M Account</paper-item>
            </paper-menu>
        </div>
    
        <paper-dialog id="lastCartDlg" modal="true">
            <img class="p4m-register-logo" src="../p4m-shared/img/logo-stacked-white.png" id="peli-icon-header" />
            <h2>Restore your last cart?</h2>
            <p class="restoreCartMessage italic">{{_restoreCartMessage}}</p>
            <p class="restoreCartStatusMessage italic"><paper-spinner id="dlgSpinner"></paper-spinner>{{_restoreCartStatusMessage}}</p>
            
            <p4m-api id="localApi" is-local="true"></p4m-api>
            <p4m-api id="p4mLoginApi" ssl="true" host-base-domain="parcelfor.me" host-type="{{hostType}}" version="v2"></p4m-api>
            <div class="buttons">
                <div class="p4m-button" on-click="_useNewCart">No</div>
                <div class="p4m-button p4m-button-active" on-click="_useLastCart">Yes</div>
            </div>
        </paper-dialog>

        <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
        <polymer-cookie id="p4mStateCookie" name="p4mState" path="/" value="{{_state}}"></polymer-cookie>
        <polymer-cookie id="p4mNonceCookie" name="p4mNonce" path="/" value="{{_nonce}}"></polymer-cookie>
        <polymer-cookie id="p4mLocalLoginCookie" name="p4mLocalLogin"></polymer-cookie>
        <polymer-cookie id="p4mOfferCartRestoreCookie" name="p4mOfferCartRestore"></polymer-cookie>
        <polymer-cookie id="p4mLocaleCookie" name="p4mLocale"></polymer-cookie>
        <polymer-cookie id="p4mAvatarUrlCookie" name="p4mAvatarUrl"></polymer-cookie>
        <polymer-cookie id="p4mDefaultCountryCodeCookie" name="p4mDefaultCountryCode"></polymer-cookie>
        <polymer-cookie id="p4mDefaultPostCodeCookie" name="p4mDefaultPostCode"></polymer-cookie>
        <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
        <polymer-cookie id="gfsCheckoutTokenCookie" name="gfsCheckoutToken"></polymer-cookie>
    </template>

    <style>
        #lastCartDlg {
            background: #37a553;
            color: #fff;
            display: flex;
            justify-content: center;
            flex-direction: column;
            padding: 35px;
            width: 430px;
            max-width: 90%;
        }
        #lastCartDlg > * {
            display: flex;
            justify-content: center;
            margin-top: 0;
        }
        #lastCartDlg > h2 {
            font-size: 28px;
            line-height: 36px;
        }
        #lastCartDlg > p {
            font-style: italic;
            font-size: 15px;
            text-align: center;
            margin: .5em 0;
        }
        #lastCartDlg .buttons {
            margin: 20px 0 0 0 !important;
            padding: 0 !important;
        }
        .restoreCartStatusMessage {
            display: none !important;
        }
        .p4m-register-logo.p4m-login {
            min-width: initial !important;
            height: auto;
            width: 128px !important;
            align-self: center;
            margin-bottom: 25px;
        }
        .p4m-menu {
            position:absolute;
            min-width:180px;
            border: 1px solid silver;
            z-index: 99;
        }
        .p4m-menu paper-item {
            min-height: 28px;
        }
        .p4m-menu paper-item:hover{
            background-color: silver;
        }
        #dlgSpinner {
            width: 50px;
            height: 50px;
        }
        .hidden {
            display: none;
        }
        .restoreCartMessage {
            display: flex;
            flex-direction: row;
        }
    </style>

    <script>
        Polymer({
            is: "p4m-login",

            properties: {
                hostType: {
                    type: String,
                },
                idSrvUrl: {
                    type: String,
                },
                clientId: {
                    type: String,
                },
                redirectUrl: {
                    type: String,
                },
                logoutForm: {
                    type: String,
                },
                p4mToken: {
                    type: String
                },
                _restoreCartMessage: {
                    type: String,
                    value: "There is a shopping cart available from your previous visit. Would you like to use it?"
                },
                _restoreCartStatusMessage: {
                    type: String
                },

                _state: {
                    type: String
                },
                _nonce: {
                    type: String
                },
                _authCompletionInterval: {
                    type: Object
                }
            },
            listeners: {

            },

            ready: function () {
                window.addEventListener('p4m-request-login', this.onRequestForLogin.bind(this));
                this._getTokenCookie();
                if (this.p4mToken) 
                {
                    // if the P4M Consumer is logged in, then check if they are logged in locally
                    var localLogin = this.$.p4mLocalLoginCookie.readCookie(); 
                    if (!localLogin || localLogin === "") {
                        // state is unknown so check first
                        this.$.localApi.call('isLocallyLoggedIn', null, null, this._onCheckLocalLogin.bind(this));
                    }
                    else if (localLogin === "false") {
                        //alert("AuthComp: "+localLogin);
                        // definitely not logged in so do it now
                        this._onAuthCompletion();
                    }
                    else {
                        var offerRestore = this.$.p4mOfferCartRestoreCookie.readCookie();
                        if (offerRestore === "true")
                        {
                            this.$.p4mOfferCartRestoreCookie.eraseCookie();
                            this.$.lastCartDlg.open();
                            //alert("Do you want to restore your last cart?");
                            // state is unknown so check first
                            
                        }
                    }
                }
                else {
                    this.clearCookies();
                	var locale = this.$.p4mLocaleCookie.readCookie();
                    if (!locale || locale === "") {
                    	// not logged in so we get the closest P4M server
                    	this.$.p4mLoginApi.call("getLocale", null, null, this._onGotLocale.bind(this));
                    }
                }
            },

            _onGotLocale: function (err, data) {
                //console.log(JSON.stringify(data));
                if (data && !data.Success) {
                    err = data.message;
                }
                if (err) {
                    throw err;
                }
                else {
                    document.cookie = "p4mLocale=" + data.Token + "; path=/";
                }
            },

            launchPopup: function () {
                if (!this.p4mToken || this.p4mToken === '') {
                    this.showPopup();
                }
                else {
                    this.showMenu();
                }
            },
			
            showPopup: function(){
                    //Make AuthUrl
                    this._makeState();
                    this._makeAuthUrl();
                    this.popupCenter(this._authUrl, "Login", 450, 500);
                    this._waitForAuthCompletion();
            },
			
            logoutThisSite: function () {
                this.clearCookies();
                if (this.logoutForm && this.logoutForm != '') {
                    var formElem = document.getElementById(this.logoutForm);
                    if (formElem) {
                        formElem.submit();
                    }
                }
                else {
                    window.location.reload(true);
                }
            },

            logoutThisDevice: function () {
                var logoutUrl = this.idSrvUrl + "/connect/endsession";
                this.popupCenter(logoutUrl, "Logout", 450, 500);
                this.clearCookies();
                if (this.logoutForm && this.logoutForm != '') {
                    var formElem = document.getElementById(this.logoutForm);
                    if (formElem) {
                        formElem.submit();
                    }
                }
                else {
                    window.location.reload(true);
                }
            },
			
            logoutAllDevices: function () {
                var logoutUrl = this.idSrvUrl + "/ui/globalLogout";
                this.popupCenter(logoutUrl, "Logout", 450, 500);
                this.clearCookies();
                if (this.logoutForm && this.logoutForm != '') {
                    var formElem = document.getElementById(this.logoutForm);
                    if (formElem) {
                        formElem.submit();
                    }
                }
                else {
                    window.location.reload(true);
                }
            },

            clearCookies: function() {
                // clear the local P4M cookies
                this.$.p4mTokenCookie.eraseCookie();
                this.$.p4mStateCookie.eraseCookie();
                this.$.p4mNonceCookie.eraseCookie();
                this.$.p4mLocalLoginCookie.eraseCookie();
                this.$.p4mOfferCartRestoreCookie.eraseCookie();
                this.$.p4mAvatarUrlCookie.eraseCookie();
                this.$.p4mDefaultCountryCodeCookie.eraseCookie();
                this.$.p4mDefaultPostCodeCookie.eraseCookie();
                this.$.p4mGivenNameCookie.eraseCookie();
                this.$.gfsCheckoutTokenCookie.eraseCookie();
            },

            popupCenter: function(url, title, w, h) {
                var left = (screen.width/2)-(w/2);
                var top = (screen.height/2)-(h/2);
                return window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=yes, scrollbars=no, resizable=no, copyhistory=no, width='+w+', height='+h+', top='+top+', left='+left);
            },

            _makeState: function() {
                this._state = Math.floor(Math.random() * 999999).toString();
                this._nonce = Math.floor(Math.random() * 999999).toString() + '-' + Math.floor(Math.random() * 999999).toString();
                this.$.p4mStateCookie.createCookie();
                this.$.p4mNonceCookie.createCookie();
            },

            _makeAuthUrl: function () {
                var authBaseUrl = this.idSrvUrl + "/connect/authorize";
                this._authUrl =
                    authBaseUrl
                    + "?response_type=code&client_id=" + this.clientId
                    + "&redirect_uri=" + this.redirectUrl
                    + "&scope=openid%20p4mApi%20p4mRetail"
                    + "&state=" + this._state
                    + "&nonce=" + this._nonce
                    + "&display=popup";
            },

            _getTokenCookie: function() {
                this.p4mToken = this.$.p4mTokenCookie.readCookie();
                return this.p4mToken;
            },

            _waitForAuthCompletion: function() {
                if (!this._authCompletionInterval) {
                    this._authCompletionInterval = window.setInterval(this._checkAuthIsComplete.bind(this), 200);
                }             
            },

            _checkAuthIsComplete: function() {
                if (this._getTokenCookie()) {
                    if (this._authCompletionInterval) {
                        window.clearTimeout(this._authCompletionInterval);
                    }
                    this._onAuthCompletion();
                }

            },

            _onAuthCompletion: function () {
                var currentPage = { "currentPage": window.location.href };
                this.$.p4mProfile.showSpinner();
                this.$.localApi.call('localLogin', currentPage, null, this._onLocalLogin.bind(this));
            },

            _onLocalLogin: function (err, data) {
                console.log(JSON.stringify(data));
                this.$.p4mProfile.hideSpinner();
                if (data.RedirectUrl) {
                    window.location.href = data.RedirectUrl;
                }
                else {
                    if (err || data.Error) {
                        console.error("A login error occurred:", err || data.Error);
                    }
                    window.location.reload(true);
                }
            },

            _onCheckLocalLogin: function (err, data) {
                //console.log(JSON.stringify(data));
                if (!data.Success)
                    this._onAuthCompletion();
            },

            _onConsumerDetails: function(data) {
                console.log(JSON.stringify(data));
            },

            _useLastCart: function () {
                this.showDlgSpinner();
                this._restoreCartStatusMessage = "Restoring cart...";
                this.$.localApi.call('restoreLastCart', null, null, this._onRestoreLastCart.bind(this));// this._onLocalLogin.bind(this));
            },

            _useNewCart: function () {
                this.$.lastCartDlg.close();
            },

            _onRestoreLastCart: function () {
                //Turn off dialog spinner
                this.hideDlgSpinner();
                this._restoreCartStatusMessage = "Restored cart";
                this.$.lastCartDlg.close();
                window.location.reload(true);
            },

            _selectMenuItem: function() {
                var selectedItemIndex = this.$['p4m-menu'].selected;
                switch (selectedItemIndex) {
                    case 0: break;
                    case 1: this.logoutThisSite(); break;
                    case 2: this.logoutThisDevice(); break;
                    case 3: this.logoutAllDevices(); break;
                    case 4: this._useLastCart(); break;
                }
            },

            _mouseOverMenu: function() {                
                if (this.$.p4mTokenCookie.readCookie() !== "") {
                    this.showMenu();
                }            
            },

            _mouseOutMenu: function () {
                //console.log('Mouseout');
                this.hideMenu();
            },

            showMenu: function(){
                this.$['p4m-menu-wrapper'].classList.remove('hidden');
            },

            hideMenu: function () {
                this.$['p4m-menu-wrapper'].classList.add('hidden');
            },

            hideDlgSpinner: function () {
                this.$.dlgSpinner.active = false;
                //this.$.dlgSpinner.classList.add('hidden');
            },

            showDlgSpinner: function () {
                this.$.dlgSpinner.active = true;
                //this.$.dlgSpinner.classList.remove('hidden');
            },

            onRequestForLogin: function () {
                //If we hear a global event calling for a login
                this.launchPopup();

            }
        });
    </script>
</dom-module>